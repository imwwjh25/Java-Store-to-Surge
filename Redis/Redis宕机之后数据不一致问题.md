Redis 宕机可能导致数据不一致（如缓存与数据库数据不匹配、分布式锁失效效等），需根据具体场景（如缓存模式、是否持久化、是否集群）采取针对性措施。以下是系统化的解决方案：

### 一、先明确 “数据不一致的根源”

Redis 宕机引发的不一致通常源于：

1. **缓存与数据库同步中断**：如 Redis 未持久化，宕机后缓存数据丢失，读取直接走数据库（暂时一致），但后续写入可能因缓存未更新导致不一致。
2. **持久化数据损坏**：RDB/AOF 文件损坏，重启后加载失败，导致缓存数据丢失或错乱。
3. **分布式场景失效**：如分布式锁基于 Redis 实现，宕机后锁释放逻辑失效，引发并发冲突。
4. **主从 / 集群同步中断**：主节点宕机未及时切换，从节点数据未同步最新变更，切换后数据回退。

### 二、核心解决方案

#### 1. **预防：减少宕机导致的数据丢失**

- **完善持久化配置**：
    - 启用 **AOF 持久化**（`appendonly yes`），并设置 `appendfsync everysec`（每秒同步一次，平衡性能与安全性），确保宕机时仅丢失 1 秒内的数据。
    - 结合 **RDB 快照**（如 `save 3600 1`），定期生成全量备份，作为 AOF 损坏时的兜底。
    - 定期校验 AOF/RDB 文件完整性（如 `redis-check-aof`、`redis-check-rdb`），避免宕机后加载损坏文件。
- **主从复制 + 哨兵 / 集群**：
    - 至少部署 1 主 2 从架构，主节点宕机后，哨兵（Sentinel）自动将从节点升级为主节点（RTO 尽可能短），减少服务中断时间。
    - 集群模式下启用 **自动故障转移**，确保单节点宕机不影响整体可用性，数据通过槽位复制保持一致。
- **限制 Redis 内存，避免 OOM 宕机**：
    - 配置 `maxmemory` 和 `maxmemory-policy`（如 `allkeys-lru`），防止内存耗尽导致 Redis 进程被内核杀死。

#### 2. **宕机后：恢复数据并修复一致性**

- **步骤 1：重启 Redis 并恢复数据**
    - 若启用 AOF：重启时优先加载 AOF 文件（`appendonly yes` 时默认），恢复最近数据。
    - 若 AOF 损坏：用 `redis-check-aof --fix` 修复，或加载最近的 RDB 快照（需接受快照后的数据丢失）。
    - 若无持久化：重启后缓存为空，需通过 “缓存预热” 重新加载热点数据（如从数据库批量加载）。
- **步骤 2：修复缓存与数据库的不一致**
    - **场景 A：缓存丢失，数据库为真**此时读取直接走数据库，可通过 “写透 + 过期时间” 逐步恢复缓存：
        - 写操作时，先更新数据库，再写入 Redis（写透模式），确保新数据同步到缓存。
        - 对未更新的旧数据，设置合理的过期时间，让缓存自动失效后从数据库加载最新值。
    - **场景 B：缓存存在脏数据（如宕机前未同步数据库）**若 Redis 重启后加载了旧数据（如 RDB 快照是几小时前的），需主动清理脏数据：
        - 对关键业务数据，通过数据库全量对比，删除缓存中与数据库不一致的键（如 `KEYS` 遍历 + 校验，生产环境慎用 `KEYS`，改用扫描 `SCAN`）。
        - 批量设置缓存键过期（`EXPIRE`），让脏数据自动失效。
- **步骤 3：处理分布式场景的遗留问题**
    - **分布式锁失效**：若宕机导致锁未释放，可通过 “锁超时时间” 自动过期，或在重启后检查所有锁键，根据业务逻辑强制释放（如比对锁的持有者 ID）。
    - **消息队列（基于 Redis）**：若用 Redis 做消息队列（如 List 结构），宕机可能导致未消费消息丢失，需结合 AOF 恢复，并补消费未处理的消息。

#### 3. **长期：架构层面规避风险**

- **引入缓存一致性模式**：
    - 优先使用 **“更新数据库 + 删除缓存”** 策略（而非更新缓存），减少缓存与数据库的同步成本，宕机后只需重新加载即可。
    - 对强一致性需求，引入 **Canal 等 binlog 同步工具**，数据库变更后异步更新 Redis，即使 Redis 宕机，恢复后也能通过 binlog 补全数据。
- **限流与降级**：
    - Redis 宕机后，通过限流（如 Guava RateLimiter）防止数据库被缓存穿透击垮。
    - 非核心业务临时降级（返回默认值），保障核心流程可用。
- **监控与告警**：
    - 实时监控 Redis 存活状态（如 `ping` 检测）、内存使用率、持久化进度，宕机后立即告警（如 Prometheus + Grafana + AlertManager）。
    - 监控主从同步延迟（`master_link_status`、`slave_repl_offset`），延迟过高时及时干预。

### 三、典型场景示例

假设电商系统中，Redis 作为商品库存缓存，宕机后缓存丢失：

1. **紧急恢复**：重启 Redis，加载 AOF 文件恢复最近库存数据；若 AOF 损坏，加载 RDB 快照，接受快照后的数据偏差。
2. **修复一致性**：对热门商品，主动从数据库查询最新库存并写入 Redis（缓存预热）；对其他商品，依赖 “读数据库 + 写缓存” 的自然恢复。
3. **预防下次**：检查 AOF 同步策略（确保 `everysec`），增加从节点数量，配置哨兵自动故障转移，避免单点宕机影响。

### 总结

Redis 宕机导致的数据不一致，需通过 “**预防（持久化 + 集群）→ 恢复（数据修复）→ 优化（架构升级）**” 三步解决。核心是减少数据丢失风险，快速恢复服务，并通过监控和一致性策略降低后续影响。实际操作中需结合业务对一致性的要求（强 / 最终一致）灵活调整方案。
