### 零拷贝技术概述

零拷贝技术是一种优化数据传输性能的技术，它通过减少数据在用户空间和内核空间之间的拷贝次数，降低 CPU 开销和内存带宽占用，从而提升系统吞吐量。在传统 I/O 操作中，数据通常需要从磁盘读取到内核缓冲区，再从内核缓冲区拷贝到用户空间，若要发送到网络，还需从用户空间拷贝到网络栈的缓冲区。零拷贝技术则通过直接映射或共享内存等方式，避免这些不必要的拷贝操作。

### mmap 和 sendfile 的区别

- 拷贝次数与上下文切换 ：

    - **mmap**：将磁盘文件映射到内核缓冲区，用户缓冲区与内核缓冲区共享映射数据，减少了一次从内核缓冲区到用户缓冲区的 CPU 拷贝，但仍需要 4 次上下文切换。其数据传输过程有 3 次拷贝，包括磁盘文件到内核缓冲区的 DMA 拷贝、内核缓冲区到 Socket 缓冲区的 CPU 拷贝以及 Socket 缓冲区到协议引擎的 DMA 拷贝。
    - **sendfile**：可以将文件描述符指向的数据直接从内核缓冲区发送到网络套接字，无需将数据拷贝到用户空间，且只需 2 次上下文切换。整个过程只有两次 DMA 拷贝，只需要从内核缓冲区拷贝一些 offset 和 length 到 Socket 缓冲区，几乎可以忽略不计，完全不需要 CPU 来进行数据拷贝，是真正意义上的零拷贝。

- 功能特性 ：

    - **mmap**：支持对映射内存区域的读写操作，应用程序可以修改内核缓冲区的数据，若需要对文件内容进行修改之后再传输，mmap 可以满足。
    - **sendfile**：无法知道文件的具体数据，它只是直接将文件的数据传输到目标缓冲区，只能用于文件传输，不适用于需要对数据进行自定义处理的场景。

- 适用场景 ：

    - **mmap**：适合小数据量的读写操作。
    - **sendfile**：更适合大文件的高效传输。

### RocketMQ 使用 mmap 的原因

RocketMQ 内部主要使用基于 mmap 实现的零拷贝来读写文件。因为 RocketMQ 在某些场景下可能需要对文件内容进行修改或处理后再传输，而 mmap 允许应用程序直接访问和修改映射的内存区域，能够满足这种对数据进行灵活处理的需求，所以选择 mmap 来提升磁盘文件的读写性能。

### Kafka 使用 sendfile 的原因

Kafka 的 Broker 在将存储在磁盘上的日志文件发送给消费者或 Follower 时，使用 sendfile。Kafka 的日志文件是顺序写入和读取的，与 sendfile 的顺序传输特性完美匹配，而且 Kafka 通常是将大量的日志数据批量发送，sendfile 可以一次性传输大块数据，进一步减少系统调用开销，能够充分发挥 sendfile 在大文件传输方面的优势，实现高吞吐量、低 CPU 使用率和低延迟的数据传输。