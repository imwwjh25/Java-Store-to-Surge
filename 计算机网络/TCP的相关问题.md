### TCP 和 UDP 的区别

TCP（传输控制协议）和 UDP（用户数据报协议）是 TCP/IP 协议栈中两种主要的传输层协议，核心区别如下：



| 特性     | TCP                                  | UDP                                    |
| -------- | ------------------------------------ | -------------------------------------- |
| 连接性   | 面向连接（三次握手建立连接）         | 无连接                                 |
| 可靠性   | 提供可靠传输（重传、确认、排序）     | 不保证可靠传输                         |
| 拥塞控制 | 有                                   | 无                                     |
| 流量控制 | 有（滑动窗口机制）                   | 无                                     |
| 速度     | 较慢（开销大）                       | 较快（开销小）                         |
| 适用场景 | 文件传输、网页浏览等需可靠传输的场景 | 视频流、实时通信等对实时性要求高的场景 |

### TCP 的流量控制和拥塞控制

1. **流量控制**
    - 目的：防止发送方发送速度过快，导致接收方缓冲区溢出
    - 实现机制：滑动窗口协议
        - 接收方通过 TCP 头部的窗口字段（Window Size）告知发送方可接收的字节数
        - 发送方的发送窗口不能超过接收方给出的窗口大小
        - 采用累计确认和超时重传机制保证可靠性
2. **拥塞控制**
    - 目的：防止发送方发送速度过快，导致网络拥塞
    - 核心算法：
        - 慢启动（Slow Start）：初始拥塞窗口较小，指数级增长
        - 拥塞避免（Congestion Avoidance）：拥塞窗口达到阈值后线性增长
        - 快速重传（Fast Retransmit）：收到 3 个重复确认后立即重传
        - 快速恢复（Fast Recovery）：重传后调整拥塞窗口，避免重新慢启动

### 服务器上一个端口的 TCP 最大连接数决定因素

TCP 连接通过四元组（源 IP、源端口、目的 IP、目的端口）唯一标识，单个服务器端口的最大连接数受以下因素限制：



1. **系统文件描述符限制**：每个连接对应一个文件描述符，操作系统有最大限制（`ulimit -n`）
2. **内存资源**：每个 TCP 连接需要占用一定内存（接收 / 发送缓冲区等）
3. **端口号范围**：客户端端口号范围限制（通常 1024-65535）
4. **操作系统参数**：如 `net.ipv4.ip_local_port_range` 等
5. **半连接队列（SYN 队列）** 和 **全连接队列（Accept 队列）** 大小限制

### 协议层面控制 TCP 连接数的方法

除了调整半连接队列和 Linux 参数，协议层面可通过以下方式控制连接：



1. **TCP 连接超时控制**：
    - 设置合理的 `TCP_TIMEWAIT` 时间（默认 60s）
    - 缩短 `TCP_SYN_RETRIES`（SYN 包重传次数）
2. **连接速率限制**：
    - 实现应用层的连接频率限制（如基于源 IP 的限流）
    - 使用 TCP 同步 ookies 抵御 SYN 洪水攻击
3. **连接复用技术**：
    - HTTP/2 或 HTTP/3 的多路复用
    - 长连接（Keep-Alive）减少频繁建立连接的开销
4. **优雅关闭连接**：
    - 合理使用 `FIN` 挥手而非 `RST` 强制关闭
    - 确保连接资源及时释放

### 服务器管理 TCP 连接的方式

服务器管理 TCP 连接通常包括以下过程：



1. **连接建立**：
    - 监听端口（`listen()`）
    - 接收连接请求（`accept()`）
    - 维护连接状态（SYN_RCVD、ESTABLISHED 等）
2. **数据传输**：
    - 维护发送 / 接收缓冲区
    - 实现滑动窗口、拥塞控制算法
    - 处理数据分片与重组
3. **连接维护**：
    - 超时检测（`TCP_keepalive` 机制）
    - 拥塞窗口动态调整
    - 异常处理（如丢包重传）
4. **连接关闭**：
    - 处理主动关闭（`close()`）和被动关闭
    - 四次挥手释放连接资源
    - 处理半关闭状态（`FIN_WAIT`、`CLOSE_WAIT` 等）
5. **高效管理机制**：
    - 使用 I/O 多路复用（select/poll/epoll/kqueue）
    - 连接池技术复用连接
    - 多线程 / 多进程模型处理并发连接
