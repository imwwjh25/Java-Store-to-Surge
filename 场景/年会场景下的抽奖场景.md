公司年会入场券抽票设计需要兼顾**公平性**（符合规则的参与者都有机会）和**灵活性**（支持多票、权重差异等需求），同时保证过程透明可追溯。以下是具体设计方案：

### 一、核心需求拆解

1. **多票场景**：同一人可能拥有多张票（如通过不同渠道获得，如部门额外分配、早到奖励等），每张票独立参与抽奖。
2. **权重差异**：不同票的中奖概率不同（如 VIP 票权重高于普通票，权重越高，中奖概率越大）。
3. **基础要求**：抽票过程可记录、可验证，避免重复中奖（同一人可中多张票时需明确规则）。

### 二、设计方案

#### 1. 票的唯一标识与属性定义

为每张票生成**唯一 ID**（如 UUID），并关联核心属性：

- `user_id`：持票人唯一标识（如员工工号）；
- `ticket_type`：票类型（如 “普通票”“VIP 票”“特邀票”）；
- `weight`：权重值（正整数，默认 1，权重越高，中奖概率越大）；
- `status`：状态（未参与、已参与、已中奖、作废）；
- `channel`：票的来源（如 “系统默认分配”“部门额外发放”）。

**示例**：
员工 A 有 2 张票：

- 票 1：类型 = 普通票，权重 = 1；
- 票 2：类型 = VIP 票，权重 = 3。

#### 2. 抽奖池构建

- **全量池**：收集所有有效票（状态为 “未参与”），按权重计算 “虚拟次数”—— 即每张票的权重值越高，在池中的 “虚拟占位次数” 越多。
  例如：权重为 3 的票，相当于在池中有 3 个 “虚拟位置”，权重为 1 的票有 1 个位置，以此提高中奖概率。
- **去重规则**：若限制 “同一人最多中 1 次”，则抽中某张票后，需将该用户的其他票从池中移除；若允许中多次，则仅标记当前票为 “已中奖”，其他票继续参与。

#### 3. 抽奖算法设计（核心）

采用**权重随机抽样**，确保权重高的票中奖概率更高，步骤如下：

- **步骤 1：计算总权重**
  统计当前抽奖池中所有票的权重之和 `total_weight`（即所有票的 `weight` 累加）。

- **步骤 2：生成随机数**
  生成一个 1 到 `total_weight` 之间的随机整数 `random_num`（闭区间）。

- **步骤 3：定位中奖票**
  遍历抽奖池中的票，累计权重 `sum`，当 `sum ≥ random_num` 时，当前票即为中奖票。

  **示例**：
  池中有 3 张票：

    - 票 A：权重 = 1（累计到 1）；
    - 票 B：权重 = 2（累计到 1+2=3）；
    - 票 C：权重 = 3（累计到 3+3=6）。
      总权重 = 6，随机数若为 4，则落在票 C 的累计区间（3 < 4 ≤ 6），票 C 中奖。

#### 4. 流程设计

1. **初始化**：
    - 录入所有票的信息（批量导入或系统自动生成），状态设为 “未参与”；
    - 配置抽奖规则（如中奖总数、每人最多中奖次数、是否允许重复中奖等）。
2. **抽奖执行**：
    - 按规则过滤出有效票（排除已中奖、作废的票）；
    - 若需限制 “每人最多中 n 次”，先检查用户已中奖次数，超过则排除其所有票；
    - 用上述权重随机算法抽取 1 张票，标记为 “已中奖”；
    - 重复执行，直到抽满预设的中奖总数，或抽奖池为空。
3. **结果校验与公示**：
    - 记录每次抽奖的时间、随机数、中奖票 ID、持票人信息，生成日志供追溯；
    - 抽完后公示中奖名单（脱敏处理，如只显示姓名 + 工号后 4 位），并允许异议申诉。

#### 5. 特殊场景处理

- **多轮抽奖**：若分多轮抽奖（如先抽纪念奖，再抽一等奖），需在每轮结束后更新票状态（已中奖的票可设置为 “不可参与后续轮次” 或 “可继续参与”，根据规则而定）。
- **权重动态调整**：支持临时调整某类票的权重（如活动前 1 小时，普通票权重翻倍），需记录调整时间和原因，保证可追溯。
- **弃票处理**：若中奖人放弃资格，从剩余池中重新抽取，并标记原中奖票为 “作废”。

### 三、技术实现关键点

1. **数据存储**：用数据库（如 MySQL）存储票信息和抽奖日志，确保持久化；
2. **性能优化**：当票数较多（如上万张）时，遍历计算累计权重可能较慢，可预先生成 “权重区间表”（如将票按顺序排列，记录每个票的权重起点和终点），随机数生成后通过二分查找定位中奖票；
3. **防作弊**：随机数生成需基于安全算法（如 Java 的`SecureRandom`），避免可预测性；抽奖过程全程记录日志，禁止手动修改中奖结果。

### 四、规则示例（场景化）

假设年会需抽 100 个奖项，规则如下：

- 普通票权重 = 1，VIP 票权重 = 2；
- 每人最多中 2 次奖；
- 中奖后仍可参与后续抽奖，但同一轮次不可重复中奖。

执行流程：

1. 第一轮抽 50 个奖：从全量池中按权重抽取，抽中后标记用户 “已中 1 次”，票状态为 “已中奖”，但该用户其他票仍在池中；
2. 第二轮抽 50 个奖：过滤掉 “已中 2 次” 的用户，从剩余票中抽取，重复上述逻辑。