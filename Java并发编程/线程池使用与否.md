### 一、为什么要用线程池？

线程池的核心价值在于**线程的复用、资源的管控和性能的优化**，本质是解决 “线程创建销毁的开销” 和 “线程数量失控的风险” 两大问题。具体原因如下：

#### 1. 降低线程创建 / 销毁的开销

线程是操作系统的宝贵资源，创建线程需要分配栈空间（默认 1-2MB）、内核对象等，销毁线程也需要回收资源，频繁创建销毁线程会产生显著的性能损耗（称为 “线程抖动”）。线程池通过复用已创建的线程，避免了重复创建销毁的开销，提升系统响应速度。

#### 2. 控制线程数量，防止资源耗尽

若不加限制地创建线程（如每个请求新建一个线程），当请求量激增时，线程数量会急剧膨胀：

- **CPU 上下文切换过载**：CPU 核心数有限，大量线程会导致频繁的上下文切换（每次切换约消耗数千个 CPU 周期），反而降低吞吐量；
- **内存耗尽**：每个线程占用栈空间，过多线程会直接导致 OOM（内存溢出）；
- **系统稳定性下降**：操作系统的线程调度压力剧增，可能引发进程崩溃或系统卡顿。

线程池通过设置核心线程数、最大线程数等参数，将线程数量控制在合理范围，避免资源耗尽。

#### 3. 提升任务执行的可管理性

线程池提供了任务排队、优先级调度、超时控制等能力：

- **任务队列**：当线程数达到核心线程数时，新任务可进入队列等待，避免直接拒绝请求；
- **拒绝策略**：当队列满且线程数达最大值时，可通过策略（如丢弃、重试、调用者执行）优雅处理过载；
- **监控与调优**：线程池可统计任务执行数、完成数、等待时间等指标，便于系统监控和性能调优。

#### 4. 支持异步任务的批量处理

线程池天然适配 “生产者 - 消费者” 模型，生产者提交任务到线程池，消费者（线程）异步处理，解耦任务提交与执行逻辑，适合批量处理异步任务（如日志收集、消息消费、数据异步处理）。

### 二、什么情况下用线程池？

线程池适用于**需要频繁创建线程、任务执行时间较短、任务量波动较大**的场景，具体包括：

#### 1. 高并发请求处理场景

如 Web 服务器（Tomcat、Nginx）处理 HTTP 请求、RPC 服务处理远程调用。这类场景下，请求量大且每个请求处理时间短，线程池可复用线程快速响应请求，避免频繁创建线程的开销。

#### 2. 批量异步任务处理场景

如：

- 电商系统中订单创建后，异步处理库存扣减、物流通知、积分计算；
- 大数据处理中，分批次处理数据分片；
- 定时任务（如 Quartz）执行周期性任务。

线程池可统一管理这些异步任务的执行，控制并发度，避免线程泛滥。

#### 3. 资源受限的场景

如：

- 数据库连接池配合线程池：线程数超过数据库连接数时，过多线程会导致连接等待，线程池可限制并发线程数，避免数据库连接耗尽；
- 计算密集型任务（如数据压缩、加密）：线程数建议设为 `CPU核心数+1`，线程池可精准控制并发数，最大化利用 CPU 资源，避免上下文切换过载。

#### 4. 需要任务调度和管控的场景

如：

- 任务需要按优先级执行（如核心业务任务优先于非核心任务）；
- 需要设置任务超时时间（如处理外部接口调用，超时则终止）；
- 需要统计任务执行效率（如监控任务平均执行时间、失败率）。

线程池（如 `ThreadPoolExecutor`）支持自定义队列（如优先级队列）、拒绝策略、线程工厂等，满足精细化管控需求。

### 三、反例：什么情况下不用线程池？

线程池并非万能，以下场景无需使用：

- **任务执行时间极长**（如小时级的后台任务）：线程池线程被长期占用，失去复用意义，直接创建独立线程更合适；
- **单线程即可处理的场景**（如简单的串行任务）：使用线程池反而增加复杂度；
- **对实时性要求极高且任务量固定**的场景：线程池的队列调度可能引入延迟，直接创建固定线程更高效。

### 总结

线程池的核心作用是**复用线程、管控资源、优化性能**，适用于**高并发、短任务、批量异步处理、资源受限**的场景。通过合理配置线程池参数（核心线程数、队列、拒绝策略），可在提升系统吞吐量的同时，保证系统稳定性。