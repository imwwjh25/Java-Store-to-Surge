### 一、缓存的分类



按存储位置和生效阶段，HTTP 缓存可分为 **强缓存** 和 **协商缓存**，两者优先级不同，流程上依次生效：

#### 1. 强缓存（本地缓存，无需请求服务器）



浏览器直接从本地缓存读取资源，不发送请求到服务器，通过以下 HTTP 头部控制：

- **`Expires`**（HTTP/1.0）作用：指定资源过期的绝对时间（如 `Expires: Wed, 21 Oct 2025 07:28:00 GMT`）。缺陷：依赖本地时间，若客户端时间被篡改（如时区错误、人为修改），可能导致缓存失效或过期资源被错误使用。

- **`Cache-Control`**（HTTP/1.1，优先级高于 `Expires`）作用：通过相对时间或指令控制缓存，更灵活可靠，常用指令：

    - `max-age=`：资源有效期（相对当前请求时间的秒数，如 `max-age=3600` 表示 1 小时内有效）。
    - `no-cache`：不使用强缓存，需强制走协商缓存（每次请求需服务器验证资源是否新鲜）。
    - `no-store`：完全不缓存（禁止浏览器和代理服务器存储任何版本的资源，每次都需重新请求）。
    - `public`：允许代理服务器（如 CDN）缓存（默认资源可能仅浏览器可缓存）。
    - `private`：仅允许客户端浏览器缓存，禁止代理服务器缓存（适用于用户私有数据，如登录后的页面）。

  示例：`Cache-Control: public, max-age=3600` 表示资源 1 小时内可被浏览器和代理缓存，直接使用。

#### 2. 协商缓存（需请求服务器验证）



当强缓存失效（资源过期），浏览器会发送请求到服务器，通过验证资源是否被修改决定是否复用本地缓存：

- 验证依据

  ：服务器通过资源的唯一标识判断是否修改，常用标识字段：

    - **`Last-Modified` + `If-Modified-Since`**

        - 服务器响应时返回 `Last-Modified: Wed, 21 Oct 2024 07:28:00 GMT`（资源最后修改时间）。

        - 再次请求时，浏览器发送```If-Modified-Since: 同上时间```，服务器对比：

      - 若未修改，返回 **304 Not Modified**（无响应体，复用本地缓存）。

      - 若已修改，返回 200 OK （带新资源和新```Last-Modified```）。

        缺陷：只能精确到秒，若资源 1 秒内多次修改，无法识别；且修改时间变化但内容未变（如手动编辑保存），会误判为修改。

- **`ETag` + `If-None-Match`**（优先级高于 `Last-Modified`）

    - 服务器响应时返回 `ETag: "abc123"`（资源内容的唯一哈希值，内容变则值变）。

    - 再次请求时，浏览器发送``` If-None-Match: "abc123"```，服务器对比：

      - 若 `ETag` 一致（内容未变），返回 **304 Not Modified**。

      - 若不一致（内容已变），返回 200 OK （带新资源和新```ETag```）。

        优势：能识别内容的细微变化，不受修改时间影响，更精准。

### 二、缓存流程总结



1. 首次请求资源：无缓存，服务器返回资源 + 缓存规则（`Cache-Control`、`Expires`、`ETag`、`Last-Modified`），浏览器存储资源和规则。

2. 再次请求：

    - 先检查强缓存：若 `Cache-Control: max-age` 未过期（或 `Expires` 未到），直接用本地缓存（**200 OK (from cache)**）。

    - 强缓存失效：发送请求到服务器，通过```If-Modified-Since```或```If-None-Match```验证：

     - 资源未变：返回 304，复用本地缓存（减少数据传输）。
     - 资源已变：返回 200，更新本地缓存和规则。

### 三、实际应用场景



- 静态资源（JS/CSS/ 图片）

  ：建议用



强缓存 + 文件名哈希 （如```app.abc123.js```）。

- 设定较长 `max-age`（如 1 年），确保缓存有效时间长。
- 资源更新时修改文件名哈希（如 `app.def456.js`），强制浏览器请求新资源（避免旧缓存生效）。

- 动态资源（API 接口、频繁变化的页面）

  ：建议用 协商缓存或禁用缓存：

- 对不敏感的动态内容，用 `ETag` 或 `Last-Modified` 减少重复传输。
- 对实时性要求高的内容（如股票数据），用 `Cache-Control: no-cache`（每次验证）或 `no-store`（完全不缓存）。

### 四、如何调试缓存？



在浏览器开发者工具（F12）的 **Network** 面板中，查看资源的 **Size** 列：

- `from memory cache` / `from disk cache`：强缓存生效（内存缓存更快，关闭页面后可能清除；磁盘缓存持久化）。
- `304 Not Modified`：协商缓存生效。
- `200 OK`：全新请求或缓存失效。