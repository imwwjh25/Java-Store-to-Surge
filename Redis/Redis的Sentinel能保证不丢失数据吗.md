
### 二、Redis Sentinel 能否保证不丢数据？为什么？

**Sentinel 不能绝对保证不丢数据**，其核心作用是**自动实现主从切换（故障转移）**，提升 Redis 集群的可用性，但数据丢失风险仍可能存在，原因如下：

#### 1. Sentinel 的核心功能（与数据可靠性相关）

Sentinel 是 Redis 的高可用解决方案，通过多个 Sentinel 节点监控主从集群，当主节点故障时，自动选举新主节点（从节点晋升），并将其他从节点指向新主节点，过程无需人工干预。

#### 2. 数据丢失的两种常见场景

##### （1）主节点故障时，未同步到从节点的数据丢失

- 主节点执行写命令后，若数据尚未同步到从节点（仍在主节点的复制缓冲区或网络传输中），主节点突然故障（如宕机），这部分数据会丢失。
- 原因：Redis 主从复制默认是 **异步复制**（主节点无需等待从节点确认，即可返回客户端成功），而非同步复制。即使配置 `repl-diskless-sync` 等参数优化同步效率，也无法完全避免异步带来的窗口期丢失。

##### （2）故障转移时，脑裂（split-brain）导致的数据丢失

- 脑裂场景：主节点因网络分区暂时与 Sentinel 和从节点断开连接，但自身仍在运行并接收客户端写请求；Sentinel 误认为主节点故障，将从节点晋升为新主节点。此时集群中出现两个主节点（旧主、新主）。
- 当网络恢复后，旧主节点会被 Sentinel 降为从节点，并从新主节点同步数据，导致旧主节点在脑裂期间接收的新数据被覆盖丢失。

#### 3. 如何降低数据丢失风险（无法完全避免）

- 配置主节点 **`min-replicas-to-write`**：指定主节点至少需要多少个从节点处于正常同步状态（偏移量差距不超过 `min-replicas-max-lag` 秒），否则拒绝写请求（牺牲可用性换一致性）。
- 配置 **`repl-ping-slave-period`**：缩短从节点向主节点发送 PING 的间隔（默认 10 秒），让主节点更快感知从节点状态。
- 避免脑裂：通过 `bind` 限制主节点的网络访问，或部署在同一机房减少网络分区概率；结合 `down-after-milliseconds` 延长 Sentinel 判断主节点故障的超时时间（降低误判概率）。

### 总结

- **主从复制过程**：建立连接 → 全量复制（RDB 同步）→ 增量复制（命令同步），实现主从数据一致。
- **Sentinel 数据可靠性**：不能绝对保证不丢数据，因异步复制存在窗口期丢失风险，且脑裂场景可能导致数据覆盖。需通过参数配置平衡可用性与一致性，但无法完全消除丢失风险。
