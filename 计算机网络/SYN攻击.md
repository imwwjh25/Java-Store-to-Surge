# SYN 攻击（SYN Flood）：原理、危害与防御方案

SYN 攻击是一种经典的 **TCP 层 DoS/DDoS 攻击**，利用 TCP 三次握手的漏洞耗尽服务器资源，导致正常用户无法建立连接。作为面试高频考点，需从「原理 - 危害 - 防御」三个维度系统性掌握，以下是详细解析：

## 一、核心原理：利用 TCP 三次握手的漏洞

要理解 SYN 攻击，首先回顾 TCP 三次握手的正常流程：

1. **客户端 → 服务器（SYN 包）**：客户端发送 SYN 包（同步序列号），请求建立连接，客户端状态变为 `SYN_SENT`。
2. **服务器 → 客户端（SYN+ACK 包）**：服务器收到 SYN 包后，在「半连接池（SYN 队列）」中记录连接信息，回复 SYN+ACK 包（确认客户端的 SYN，同时发送自己的 SYN），服务器状态变为 `SYN_RECV`。
3. **客户端 → 服务器（ACK 包）**：客户端收到 SYN+ACK 包后，回复 ACK 包，服务器收到后将连接从半连接池移入「全连接池（Accept 队列）」，状态变为 `ESTABLISHED`，连接建立完成。

### SYN 攻击的核心漏洞

服务器在发送 SYN+ACK 包后，会**默认保留半连接状态一段时间**（等待客户端的 ACK 包），期间会占用服务器的「半连接池资源」和「端口资源」。攻击者利用这一点，构造大量**伪造源 IP 的 SYN 包**发送给服务器：

- 服务器收到 SYN 包后，分配半连接资源并回复 SYN+ACK 包，但由于源 IP 是伪造的，客户端永远不会回复 ACK 包。
- 服务器会持续等待 ACK 包，直到超时（默认约 30-60 秒）才释放半连接资源。
- 当攻击流量足够大时，服务器的半连接池会被迅速占满，无法处理正常用户的 SYN 请求，导致服务拒绝。

## 二、攻击特征与危害

### 1. 典型特征

- 服务器上 `SYN_RECV` 状态的连接数量暴增（可通过 `netstat -an | grep SYN_RECV` 查看）。
- 正常用户无法访问服务器的 TCP 服务（如 Web、SSH），出现「连接超时」错误。
- 服务器 CPU 利用率、内存利用率可能无明显飙升，但端口资源被耗尽（半连接池满）。

### 2. 主要危害

- **拒绝服务（DoS）**：单台服务器被攻击后，TCP 服务不可用。
- **分布式拒绝服务（DDoS）**：攻击者控制大量肉鸡（僵尸网络）同时发起攻击，流量规模可达 Gbps 级别，甚至瘫痪大型服务器集群。
- **资源耗尽**：服务器为维持大量无效半连接，消耗 CPU（处理 SYN 包）、内存（存储半连接信息）资源，间接影响其他服务。

## 三、防御方案：从内核优化到架构防护

防御 SYN 攻击的核心思路是「**减少半连接资源占用、快速识别并丢弃恶意 SYN 包、扩容抗攻击能力**」，分为以下多层防御：

### 1. 操作系统内核参数优化（基础防御）

通过调整 Linux/Windows 内核参数，限制半连接资源占用、缩短超时时间，提升服务器抗攻击能力。

#### Linux 核心参数（`/etc/sysctl.conf`）

| 参数                           | 作用                                        | 推荐配置                                    |
| ------------------------------ | ------------------------------------------- | ------------------------------------------- |
| `net.ipv4.tcp_max_syn_backlog` | 半连接池（SYN 队列）最大容量                | `10240`（默认 128，调大后可容纳更多半连接） |
| `net.ipv4.tcp_synack_retries`  | 服务器发送 SYN+ACK 后的重试次数             | `1-2`（默认 5，减少重试可快速释放无效连接） |
| `net.ipv4.tcp_syn_retries`     | 客户端发送 SYN 后的重试次数（防御反射攻击） | `1`                                         |
| `net.ipv4.tcp_syncookies`      | 开启 SYN Cookie 机制（核心防御）            | `1`（默认 0，开启后无需存储半连接）         |
| `net.ipv4.tcp_fin_timeout`     | 连接关闭后的超时时间                        | `30`（默认 60，缩短释放资源时间）           |

#### 配置生效命令










```bash
sysctl -p  # 加载配置
```

#### 关键机制：SYN Cookie

- **原理**：当半连接池满时，服务器不存储半连接信息，而是通过「客户端 IP、端口、服务器 IP、端口 + 随机数」生成一个 SYN Cookie（加密后的序列号），作为 SYN+ACK 包的序列号发送给客户端。

- 验证过程 ：

    1. 客户端收到 SYN+ACK 后，会用 Cookie 作为确认号回复 ACK 包。
    2. 服务器收到 ACK 后，验证 Cookie 合法性（解密后核对信息），合法则直接建立连接（无需半连接池）。

- **优势**：彻底避免半连接池被占满，几乎不消耗服务器资源，是防御 SYN 攻击的核心手段。

### 2. 网络设备防护（中层防御）

利用防火墙、负载均衡器等网络设备，在流量进入服务器前过滤恶意 SYN 包。

#### （1）防火墙过滤（iptables / 云防火墙）

- 限制 SYN 包速率 ：通过```iptables```限制单位时间内的 SYN 包数量，避免流量洪峰。





  ```bash
  # 限制每秒最多接收 100 个 SYN 包，超出则丢弃
  iptables -A INPUT -p tcp --syn -m limit --limit 100/s --limit-burst 200 -j ACCEPT
  iptables -A INPUT -p tcp --syn -j DROP
  ```



- **伪造 IP 过滤**：禁止来自私有 IP 段（如 192.168.0.0/16）的公网访问（攻击者常伪造私有 IP）。

- **状态检测**：开启防火墙的「状态检测」功能，仅允许合法的 TCP 连接（如已建立的 `ESTABLISHED` 状态）通过。

#### （2）负载均衡器（Nginx/HAProxy/ 云 LB）

- **流量分发**：将攻击流量分散到多台服务器，避免单台服务器过载。
- **SYN 代理**：负载均衡器作为中间代理，先与客户端完成三次握手，再与后端服务器建立连接（后端服务器仅处理 `ESTABLISHED` 状态的连接，隔绝 SYN 攻击）。
- **黑洞路由**：对持续发送大量 SYN 包的恶意 IP，配置黑洞路由（直接丢弃该 IP 的所有流量）。

### 3. 架构层面防护（高层防御）

针对大规模 DDoS 级别的 SYN 攻击，需通过架构设计提升抗攻击能力。

#### （1）CDN / 抗 DDoS 服务商

- 借助 CDN（如阿里云 CDN、Cloudflare）或专业抗 DDoS 服务商（如阿里云高防、腾讯云大禹）的清洗中心，过滤攻击流量。
- 原理：攻击流量先进入服务商的节点，经过流量清洗（识别恶意 SYN 包并丢弃）后，仅将正常流量转发到源服务器。
- 优势：可抵御 Tbps 级别的超大流量攻击，是企业级防护的首选。

#### （2）服务器集群与冗余

- 部署多台服务器组成集群，通过负载均衡器分发流量，即使部分服务器被攻击，其他服务器仍可提供服务。
- 避免单点故障，提升服务可用性。

#### （3）应用层优化

- 减少 TCP 服务暴露：非必要的 TCP 端口（如 22、3389）可通过防火墙关闭，仅开放业务必需端口（如 80、443）。
- 改用 UDP 服务（如 DNS、视频流）：若业务允许，可使用 UDP 协议（无需三次握手），从根本上避免 SYN 攻击。

## 四、面试高频考点总结

1. **SYN 攻击的本质**：利用 TCP 三次握手的 `SYN_RECV` 状态漏洞，耗尽服务器半连接资源。
2. **核心防御手段**：SYN Cookie（内核级）、防火墙速率限制（网络级）、CDN 流量清洗（架构级）。
3. **SYN Cookie 的原理**：无状态验证机制，通过加密 Cookie 替代半连接池，避免资源占用。
4. **半连接池与全连接池的区别**：半连接池存储 `SYN_RECV` 状态的连接，全连接池存储 `ESTABLISHED` 状态的连接；SYN 攻击主要占满半连接池。
5. **如何排查 SYN 攻击**：通过 `netstat -an | grep SYN_RECV` 查看异常半连接数量；通过 `tcpdump` 抓包分析 SYN 包来源。

## 总结

SYN 攻击的核心是「滥用 TCP 三次握手的半连接状态」，防御的关键是「打破半连接资源占用的恶性循环」。实际面试中，需重点掌握 SYN Cookie 原理、内核参数优化、多层防御架构，同时结合之前学习的 TCP 三次握手、半连接池等知识点，形成完整的知识体系。