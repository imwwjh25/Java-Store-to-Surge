TCP 中滑动窗口的大小由接收方允许的窗口（Receiver Window，RWIN）和拥塞窗口（Congestion Window，CWND）共同决定。发送方在任何时刻的有效发送窗口大小等于 RWIN 和 CWND 中的最小值，即发送窗口大小 = min (RWIN,CWND)。



接收方的窗口大小（RWIN）主要由以下因素控制：



- **接收方缓冲区的可用空间**：接收方通过 TCP 报头中的窗口大小字段向发送方通告其接收能力，该值反映了接收方缓冲区的可用空间。当接收方应用进程从接收缓冲区中读取数据后，接收缓冲区的可用空间增加，接收窗口会相应增大；反之，若接收方应用进程读取数据较慢，导致接收缓冲区剩余空间减少，接收窗口则会减小。
- **操作系统的资源分配**：接收方的系统资源状况会影响接收窗口大小。当系统资源紧张时，操作系统可能会减少接收缓冲区的大小，从而使接收窗口变小。
- **窗口缩放选项（Window Scale Option）**：如果启用了窗口缩放选项，接收方可以通过该选项协商一个缩放因子，使得实际的接收窗口大小能够大于 64KB，以适应高带宽延迟积的网络环境。


### 发送方如何知道接收方窗口大小

在 TCP 协议中，发送方通过接收方在 TCP 报文段中携带的**窗口大小字段（Window Size Field）** 来获取接收方的窗口大小（RWIN）。具体过程如下：



1. **接收方主动通告窗口大小**
   接收方在每次发送 TCP 报文（包括数据报文、确认报文 ACK 等）时，会在 TCP 头部的**窗口字段（16 位）** 中填入当前的接收窗口大小（即接收缓冲区的可用空间），以此告知发送方可继续发送的数据量上限。
2. **发送方动态更新窗口信息**
   发送方收到接收方的报文后，会解析 TCP 头部的窗口字段，获取最新的接收窗口大小（RWIN），并结合自身的拥塞窗口（CWND），计算出当前允许发送的有效窗口（即`min(RWIN, CWND)`），从而调整后续的发送策略。
3. **特殊情况的处理**
    - 若接收方缓冲区已满，会将窗口大小设为 0（“零窗口”），此时发送方需停止发送数据，并启动**零窗口探测（Zero Window Probe）** 机制，定期发送小报文询问接收方窗口是否已恢复。
    - 若双方协商启用了**窗口缩放选项（Window Scale Option）**（TCP 头部的可选字段），则实际接收窗口大小为报文中的窗口字段值乘以缩放因子，以支持超过 64KB 的大窗口（适应高带宽网络）。



通过这种机制，TCP 能动态适配接收方的处理能力，避免接收方缓冲区溢出，实现流量控制。


### 零窗口探测（Zero Window Probe） 机制

零窗口探测（Zero Window Probe）机制是 TCP 协议中用于解决接收方窗口为零导致发送方停止发送数据后可能出现死锁问题的一种机制，具体如下：



- **触发条件**：当发送方收到接收方发送的窗口大小为零的 TCP 报文（即零窗口通知）时，会启动零窗口探测定时器（也叫持续定时器，Persistence Timer）。

- 探测过程 ：

    - **有已发送未确认数据时**：如果 TCP 发送方还有 “已发送未确认” 的数据，那么它会继续发送这些数据，这些数据可当作零窗口探测报文使用，也称为 “广义零窗口探测报文”。接收方收到后，若接收窗口仍为零，会再次返回窗口为零的 ACK 报文；若接收窗口变为非零，则会在 ACK 报文中告知发送方新的窗口大小，发送方收到后即可恢复数据发送。
    - **没有已发送未确认数据时**：若发送方没有 “已发送未确认” 的数据，但还有数据需要发送，它会发送一个特殊的 ACK 报文作为零窗口探测报文（狭义零窗口探测报文），该报文数据长度为 0，SEQ 等于 SND.NXT - 1。接收方收到后会返回一个 ACK 报文，告知发送方当前的窗口大小。

- 定时器管理 ：

    - **初始设置**：零窗口探测定时器启动时，其超时时间通常设置为一个较小的值，如 1 秒。
    - **指数退避**：如果接收方在响应零窗口探测报文时，仍然告知其接收窗口为零，那么发送方会根据指数退避算法重新设置零窗口探测定时器的下次超时时间，超时时间依次为 1 秒、2 秒、4 秒、8 秒、16 秒…… 直到最大值 64 秒，以后的周期都保持为 64 秒。

- **作用**：零窗口探测机制通过定期发送探测报文，使得即使接收方的窗口暂时为零，通信双方也能保持联系，避免因接收方告知窗口非零的 ACK 报文丢失而导致的死锁，从而确保 TCP 连接能够在接收方有足够缓存空间时及时恢复数据传输。
