# TLS 四次握手（TLS 1.2/1.3 核心流程 + 原理拆解）

TLS（Transport Layer Security）的 “四次握手” 是 **客户端与服务器建立安全连接、协商加密参数** 的核心流程，核心目标是：① 身份验证（单向 / 双向）；② 协商对称加密密钥；③ 验证通信完整性，最终实现 “明文协商→密钥加密传输” 的安全过渡。

注意：TLS 1.2 是经典的四次握手，TLS 1.3 优化为 “简化四次握手”（本质是合并部分步骤，减少往返），面试需重点掌握 TLS 1.2 流程，再补充 1.3 的优化点。

## 一、先明确核心前提

1. 加密算法分类：

   - 非对称加密（如 RSA、ECDH）：用于 “协商密钥”（加密对称密钥）和 “身份验证”（验证证书），速度慢但安全性高；
   - 对称加密（如 AES）：用于 “传输数据加密”，速度快，适合大量数据；
   - 哈希算法（如 SHA-256）：用于 “完整性校验”（验证数据未被篡改）和 “生成会话密钥”。

2. **核心目标**：通过四次交互，让客户端和服务器安全协商出 **会话密钥（对称密钥）**，后续所有通信都用该密钥加密。

## 二、TLS 1.2 经典四次握手流程（详细拆解）

### 第 1 次握手：客户端 → 服务器（Client Hello）

- 发送内容：

  1. 客户端支持的 TLS 版本（如 TLS 1.2）；
  2. 客户端支持的加密套件列表（如 `TLS_RSA_WITH_AES_256_GCM_SHA384`，格式：密钥交换算法 + 对称加密算法 + 哈希算法）；
  3. 随机数 `Client Random`（32 字节，用于后续生成会话密钥）；
  4. 扩展字段（如 SNI 服务器名称指示，用于一台服务器部署多个域名证书）。

- **核心目的**：向服务器告知 “我支持的 TLS 能力”，提供初始随机数，发起连接请求。

### 第 2 次握手：服务器 → 客户端（Server Hello + 证书 + 密钥交换信息 + Server Hello Done）

这一步是服务器的 “响应包”，包含 4 个关键部分，合并为一次传输（所以算一次握手）：

1. Server Hello：

   - 确认 TLS 版本（如 TLS 1.2）；
   - 从客户端的加密套件列表中选择一个支持的套件（如 `TLS_RSA_WITH_AES_256_GCM_SHA384`）；
   - 服务器随机数 `Server Random`（32 字节，与 Client Random 共同用于生成会话密钥）。

2. Certificate（证书）：

   - 服务器向客户端发送数字证书（由 CA 颁发），包含服务器公钥、域名、证书有效期等信息；
   - 若启用 M-TLS（双向认证），服务器还会要求客户端提供证书。

3. 密钥交换信息（Server Key Exchange，可选）：

   - 若选择的加密套件是 ECDH（椭圆曲线 Diffie-Hellman），服务器会发送 ECDH 公钥参数（如椭圆曲线类型、公钥值）；
   - 若选择 RSA 密钥交换，此步骤省略（直接用证书中的 RSA 公钥）。

4. **Server Hello Done**：告知客户端 “服务器响应完毕，等待客户端下一步操作”。

- **核心目的**：确认加密参数，提供服务器身份凭证（证书），传递密钥交换所需的公钥信息。

### 第 3 次握手：客户端 → 服务器（证书验证 + 密钥交换信息 + 会话密钥加密 + Client Finished）

客户端收到服务器响应后，执行一系列关键操作，再向服务器发送数据：

1. 验证服务器证书

   （核心步骤）：

   - 验证证书合法性：是否由可信 CA 颁发、证书未过期、域名与服务器域名一致、证书链完整；
   - 若验证失败，客户端会弹出 “证书风险” 提示，中断连接（如浏览器提示 “此网站不安全”）。

2. 生成预主密钥（Pre-Master Secret，PMS）：

   - 客户端生成一个随机数 `Pre-Master Secret`（48 字节）；
   - 用服务器证书中的公钥（或 ECDH 公钥）加密 `PMS`，得到 “加密后的 PMS”（只有服务器的私钥能解密）。

3. 发送密钥交换信息：

   - 向服务器发送 “加密后的 PMS”；
   - 若启用 M-TLS，客户端还会发送自己的证书，以及用服务器公钥加密的客户端密钥信息。

4. 生成会话密钥（Master Secret）：

   - 客户端用 `Client Random + Server Random + Pre-Master Secret`，通过哈希算法（如 SHA-256）生成 **会话密钥**（对称密钥，用于后续数据加密）；
   - 会话密钥还会衍生出 “加密密钥”“MAC 密钥”（用于完整性校验）等。

5. Client Finished：

   - 客户端用会话密钥加密 “握手过程的所有消息摘要”（即 Client Hello、Server Hello 等所有交互数据的哈希值），发送给服务器；
   - 用于服务器验证 “握手过程未被篡改”，且客户端已正确生成会话密钥。

- **核心目的**：验证服务器身份，安全传递预主密钥，生成会话密钥，验证握手完整性。

### 第 4 次握手：服务器 → 客户端（密钥解密 + Server Finished）

服务器收到客户端数据后，完成最终确认：

1. 解密预主密钥：

   - 服务器用自己的私钥（RSA 私钥或 ECDH 私钥）解密 “加密后的 PMS”，得到 `Pre-Master Secret`。

2. 生成会话密钥：

   - 服务器用与客户端相同的算法（`Client Random + Server Random + Pre-Master Secret`）生成 **相同的会话密钥**（对称密钥的一致性由非对称加密保障）。

3. 验证 Client Finished：

   - 服务器用会话密钥解密 “Client Finished” 中的消息摘要，与自己保存的握手消息摘要对比；
   - 若一致，说明握手过程未被篡改，客户端已正确生成会话密钥。

4. Server Finished：

   - 服务器用会话密钥加密 “握手过程的所有消息摘要”，发送给客户端；
   - 客户端收到后，解密并验证摘要一致性。

5. **握手完成**：双方确认会话密钥一致，握手结束，后续所有应用数据（如 HTTP 请求）都用会话密钥加密传输。

- **核心目的**：解密得到预主密钥，生成会话密钥，验证握手完整性，确认安全连接建立。

## 三、TLS 1.3 简化四次握手（优化点）

TLS 1.3 为了减少延迟，将经典四次握手优化为 “逻辑四次，实际两次往返”（合并部分步骤）：

1. **第 1 次握手（Client Hello）**：客户端除了发送支持的 TLS 版本、加密套件、Client Random，还会提前发送 ECDH 公钥（密钥交换参数），避免额外往返。
2. **第 2 次握手（Server Hello + 证书 + 密钥交换 + Server Finished）**：服务器直接确认加密套件、发送证书、ECDH 公钥，同时生成会话密钥，发送 Server Finished（合并了 TLS 1.2 的第 2、4 步核心内容）。
3. **第 3 次握手（Client Finished）**：客户端验证证书后，生成会话密钥，发送 Client Finished（与 TLS 1.2 第 3 步核心一致）。
4. **第 4 次握手（可选）**：若有应用数据需立即发送，可合并在 Client Finished 后，无需额外往返。

核心优化：减少 1 次网络往返，握手延迟降低约 50%，同时移除了不安全的加密套件（如 RSA 密钥交换、SHA-1 哈希），安全性更高。

## 四、面试高频考点（必背）

1. **四次握手的核心目标**：身份验证（服务器 / 客户端）、协商对称密钥、验证通信完整性，最终建立安全的加密连接。
2. **会话密钥的生成逻辑**：由 Client Random + Server Random + Pre-Master Secret 通过哈希算法生成，三者缺一不可（保证密钥随机性和一致性）。
3. **非对称加密的作用**：仅用于 “握手阶段” 的身份验证和预主密钥加密，不用于传输应用数据（对称加密速度更快）。
4. **证书的作用**：验证服务器身份，防止中间人攻击（确保客户端连接的是真实服务器，而非伪造的中间节点）。
5. **TLS 1.2 与 1.3 的区别**：1.3 简化握手流程（减少往返）、移除不安全加密套件、提升速度和安全性。

## 五、面试回答总结（结构化 + 核心要点）

“TLS 四次握手是建立安全连接的核心流程，TLS 1.2 是经典实现，1.3 做了优化，核心逻辑如下：

1. 第 1 次：客户端发 TLS 版本、加密套件、Client Random，发起请求；
2. 第 2 次：服务器确认版本和加密套件，发 Server Random、证书（含公钥），告知响应完毕；
3. 第 3 次：客户端验证证书，生成 Pre-Master Secret 并用服务器公钥加密发送，再结合两个随机数生成会话密钥，发 Client Finished 验证完整性；
4. 第 4 次：服务器用私钥解密 PMS，生成相同会话密钥，发 Server Finished 确认，握手完成。

核心目的是通过非对称加密验证身份、协商对称密钥，后续用对称密钥加密传输数据。TLS 1.3 优化后减少了网络往返，安全性和速度都有提升。”
