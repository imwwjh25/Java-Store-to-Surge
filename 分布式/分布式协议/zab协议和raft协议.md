Raft 协议和 ZAB 协议都是分布式系统中保证数据一致性的共识协议，核心区别在于设计目标与应用场景，Raft 以**易理解性**为核心设计，ZAB 则是为 **ZooKeeper** 定制的专用协议。

### 1. 核心定位与设计目标

两者的根本差异源于设计初衷，直接决定了它们的应用场景。

- **Raft 协议**：通用型共识协议，核心目标是**简化理解与实现**。它将复杂的共识流程拆分为清晰的角色和阶段，降低了分布式一致性协议的学习与开发门槛，适用于各类需要强一致性的分布式系统（如 Etcd、Redis Cluster）。
- **ZAB 协议**：专为 **ZooKeeper** 设计的专用协议，核心目标是**适配 ZooKeeper 的树形数据结构与读写场景**。它在保证一致性的同时，优化了 ZooKeeper 特有的 “读多写少” 场景下的性能，是与 ZooKeeper 深度绑定的协议。

### 2. 核心角色与职责

两者都通过 “领导者（Leader）” 统一协调，但角色划分与职责有细微差异。

| 协议 | 核心角色            | 角色职责                                                     |
| ---- | ------------------- | ------------------------------------------------------------ |
| Raft | 领导者（Leader）    | 接收客户端写请求，向追随者同步日志，发起投票确认日志提交。   |
|      | 追随者（Follower）  | 接收 Leader 同步的日志，响应 Leader 的投票请求，仅处理客户端读请求。 |
|      | 候选人（Candidate） | 当 Leader 失联时，Follower 转化为 Candidate，发起投票竞争新 Leader。 |
| ZAB  | 领导者（Leader）    | 接收客户端写请求，生成事务提案（Proposal），向追随者同步提案并确认提交。 |
|      | 追随者（Follower）  | 接收 Leader 的提案，响应 Leader 的确认请求，同步日志，可处理读请求。 |
|      | 观察者（Observer）  | 仅同步 Leader 日志、处理读请求，不参与投票和提案确认，用于扩展读性能。 |

### 3. 核心流程（选主与日志同步）

两者都包含 “选主” 和 “日志同步” 两个关键阶段，但流程细节不同。

#### （1）选主流程

- **Raft**：基于 “任期（Term）” 的投票机制，流程清晰。
    1. Follower 发现 Leader 失联后，递增自身任期号，转化为 Candidate 并向所有节点发起投票。
    2. 其他节点若未在当前任期投票，会投票给该 Candidate；Candidate 获得多数票后成为新 Leader。
    3. 若出现多个 Candidate 竞争（票数均分），则当前任期无 Leader，等待超时后进入下一个任期重新投票。
- **ZAB**：基于 “ZXID（事务 ID）” 的优先级投票，优先选择日志更完整的节点。
    1. Leader 失联后，Follower 转化为 “潜在领导者”，向其他节点发起投票请求，同时携带自身最新的 ZXID（ZXID 越大，日志越新、越完整）。
    2. 其他节点会投票给 ZXID 最大的潜在领导者，确保新 Leader 拥有集群中最完整的日志，避免数据丢失。

#### （2）日志同步流程

- **Raft**：“日志复制 + 多数确认” 机制，强调日志的顺序性。
    1. Leader 接收客户端写请求后，将请求封装为日志条目，追加到本地日志。
    2. Leader 向所有 Follower 同步该日志条目，等待 Follower 的 “已接收” 确认。
    3. 当 Leader 收到**多数节点**的确认后，将日志标记为 “已提交”，并向客户端返回成功；同时通知 Follower 将日志提交。
- **ZAB**：“提案 + 确认” 的两阶段提交，适配 ZooKeeper 的事务模型。
    1. Leader 接收写请求后，生成带有 ZXID 的事务提案（Proposal），向所有 Follower 发送 “提案同步” 请求。
    2. Follower 接收提案后，将其写入本地日志，向 Leader 返回 “已同步” 确认。
    3. 当 Leader 收到**多数节点**的确认后，向所有 Follower 发送 “提交” 指令，Follower 执行提案并更新本地数据，最终向客户端返回成功。

### 4. 关键特性差异

| 对比维度       | Raft 协议                            | ZAB 协议                         |
| -------------- | ------------------------------------ | -------------------------------- |
| 日志标识       | 任期号（Term）+ 日志索引             | ZXID（64 位，含任期 + 事务序号） |
| 读性能优化     | 无特殊角色，读请求仅由 Follower 处理 | 支持 Observer 角色，扩展读性能   |
| 适用场景       | 通用分布式系统（Etcd、Redis）        | 仅 ZooKeeper 及其生态            |
| 数据一致性保证 | 强一致性（多数节点确认后提交）       | 强一致性（基于 ZXID 有序性）     |

### 总结

- 若需**开发通用分布式系统**，追求协议的易理解、易实现，优先选择 **Raft**。
- 若需**基于 ZooKeeper 进行二次开发**，则必须遵循其内置的 **ZAB** 协议。