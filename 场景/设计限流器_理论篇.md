常见的限流算法包括**令牌桶算法**、**漏桶算法**、**固定窗口计数法**、**滑动窗口计数法**和**漏桶令牌混合算法**等，它们各自有不同的原理和适用场景。

------

## 1. 令牌桶算法（Token Bucket）

### 原理

- 系统以固定速率向令牌桶中添加令牌。
- 当有请求到达时，会尝试从桶中获取一个令牌。
- 如果桶中有令牌，则请求被允许处理，同时令牌数减一。
- 如果桶中没有令牌，则请求被限流（拒绝或排队）。
- 令牌桶可以累积一定量的令牌，允许突发流量在令牌累积范围内被处理。

### 应用场景

- **需要处理突发流量的场景**：例如 API 接口、微服务调用。
- **令牌桶允许一定程度的流量高峰**，适合对流量波动较大的场景进行限流。
- 典型应用：
    - API 网关限流（如 Spring Cloud Gateway、Kong）。
    - 消息队列的生产者限流，防止消息堆积过快。

------

## 2. 漏桶算法（Leaky Bucket）

### 原理

- 请求像水一样注入漏桶，漏桶以固定速率将水漏出（处理请求）。
- 如果请求注入速度超过漏桶的漏水速度，桶会溢出（请求被限流）。
- 漏桶的容量是固定的，溢出的请求会被丢弃或排队。

### 应用场景

- **需要严格控制流出速率的场景**：例如服务器的数据库查询、网络带宽控制。
- 漏桶算法能有效平滑突发流量，确保流出速率稳定。
- 典型应用：
    - 数据库查询限流，防止因查询过多导致数据库压力过大。
    - 网络流量整形（Traffic Shaping），控制数据包发送速率。

------

## 3. 固定窗口计数法（Fixed Window Counter）

### 原理

- 将时间划分为固定大小的窗口（如 1 秒）。
- 每个窗口维护一个计数器，记录窗口内的请求数量。
- 当请求到达时，如果计数器小于阈值，则允许处理并递增计数器。
- 如果计数器达到阈值，则请求被限流。
- 窗口结束时，计数器清零，开始新的窗口计数。

### 应用场景

- **对精度要求不高、实现简单的场景**：例如简单的 API 接口限流。
- 固定窗口计数法实现简单，但可能存在窗口切换时的流量突增问题。
- 典型应用：
    - 简单的接口访问频率限制（如每秒最多 100 次请求）。
    - 分布式系统中的限流（需要考虑窗口同步问题）。

------

## 4. 滑动窗口计数法（Sliding Window Counter）

### 原理

- 将时间划分为多个小窗口（如 1 秒划分为 10 个 100ms 的小窗口）。
- 每个小窗口维护一个计数器，记录窗口内的请求数量。
- 当请求到达时，计算当前时间窗口内的总请求数（所有小窗口计数器之和）。
- 如果总请求数小于阈值，则允许处理并递增对应小窗口的计数器。
- 如果总请求数达到阈值，则请求被限流。
- 随着时间推移，旧的小窗口会被移除，新的小窗口会被添加。

### 应用场景

- **对精度要求较高、需要平滑限流的场景**：例如 API 接口、秒杀系统。
- 滑动窗口计数法能有效解决固定窗口计数法的窗口切换突增问题，限流更平滑。
- 典型应用：
    - 秒杀系统中的请求限流，防止瞬间流量过大。
    - 微服务间的调用限流，确保服务稳定性。

------

## 5. 漏桶令牌混合算法（Token Bucket with Leaky Bucket）

### 原理

- 结合了令牌桶和漏桶的优点：令牌桶负责控制平均速率和允许突发流量，漏桶负责平滑流出速率。
- 请求首先经过令牌桶获取令牌，然后进入漏桶等待处理。
- 令牌桶可以累积令牌，允许突发流量；漏桶以固定速率处理请求，确保流出速率稳定。

### 应用场景

- **需要同时控制平均速率、允许突发流量和平滑流出速率的场景**：例如 Web 服务器的请求处理、消息队列的消费限流。
- 典型应用：
    - Web 服务器的请求限流，既允许一定的突发流量，又避免服务器压力过大。
    - 消息队列的消费限流，确保消费者按能力处理消息，避免消息堆积。

------

## 总结

| 算法             | 核心特点                   | 适用场景                                 |
| ---------------- | -------------------------- | ---------------------------------------- |
| 令牌桶算法       | 允许突发流量，控制平均速率 | API 接口、微服务调用、消息生产者限流     |
| 漏桶算法         | 严格控制流出速率，平滑流量 | 数据库查询、网络带宽控制、流量整形       |
| 固定窗口计数法   | 实现简单，精度较低         | 简单 API 接口限流、对精度要求不高的场景  |
| 滑动窗口计数法   | 精度较高，限流平滑         | 秒杀系统、微服务调用、对精度要求高的场景 |
| 漏桶令牌混合算法 | 结合两者优点，控制更灵活   | Web 服务器、消息队列消费限流             |