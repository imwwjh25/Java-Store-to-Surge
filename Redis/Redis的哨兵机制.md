### 4. Redis 哨兵（Sentinel）的实现原理

你想了解 Redis 哨兵的具体实现，核心是哨兵集群通过**监控、通知、自动故障转移**保证 Redis 主从集群的高可用，以下是核心流程和原理：

#### 核心角色

- **哨兵节点**：独立的 Redis 进程（非业务进程），通常部署 3 + 个（奇数，避免脑裂）；
- **主节点（Master）**：处理写请求；
- **从节点（Slave）**：同步主节点数据，处理读请求。

#### 实现流程（分 4 步）

##### 1. 监控（Monitoring）

- 哨兵每隔 1 秒向主节点、从节点发送`PING`命令，检测节点存活状态；
- 哨兵每隔 10 秒向主节点发送`INFO`命令，获取从节点列表；
- 哨兵之间每隔 2 秒通过主节点的`__sentinel__:hello`频道交换信息（节点状态、哨兵列表）。

##### 2. 主观下线（Subjectively Down，SDOWN）

- 若哨兵在`down-after-milliseconds`（默认 30 秒）内未收到主节点的有效 PONG 响应，标记主节点为 “主观下线”；
- 仅当前哨兵认为主节点不可用，不触发故障转移。

##### 3. 客观下线（Objectively Down，ODOWN）

- 哨兵向其他哨兵发送 “主节点是否下线” 的询问请求；
- 若超过`quorum`（法定票数，一般为哨兵数 / 2+1）的哨兵确认主节点主观下线，标记主节点为 “客观下线”；
- 只有主节点会触发客观下线，从节点仅主观下线。

##### 4. 自动故障转移（Failover）

1. **选举领头哨兵**：通过 Raft 算法从哨兵集群中选举一个领头哨兵（只有领头哨兵执行故障转移）；

2. 选择新主节点：

   - 过滤掉下线、响应慢的从节点；
   - 优先选择与主节点同步偏移量最大的从节点（数据最完整）；
   - 若偏移量相同，选择`runid`小的从节点（启动早的）；

3. 切换主从：

   - 领头哨兵向新主节点发送`SLAVEOF NO ONE`命令，使其成为主节点；
   - 向其他从节点发送`SLAVEOF 新主节点IP 端口`命令，同步新主节点数据；
   - 更新哨兵集群的主节点配置，通知客户端（通过发布订阅）；

4. **原主节点恢复**：原主节点重启后，会被哨兵设置为新主节点的从节点。

#### 核心配置（关键参数）


```conf
# 监控主节点（mymaster为集群名称，quorum为法定票数）
sentinel monitor mymaster 127.0.0.1 6379 2
# 主观下线超时时间
sentinel down-after-milliseconds mymaster 30000
# 故障转移超时时间
sentinel failover-timeout mymaster 180000
# 每次向从节点同步的最大数量（避免同步压力过大）
sentinel parallel-syncs mymaster 1
```

**Quorum**（法定票数 / 仲裁数）是分布式系统中用于**达成共识、判定状态、触发决策**的核心阈值，目的是避免分布式环境下因网络分区、节点故障导致的决策混乱。

简单来说：**只有获得超过 quorum 数量的节点同意，才能认定某个状态有效或执行某个操作**。

### 一、核心作用

在分布式系统中，quorum 主要解决两个核心问题：

1. **一致性判定**：确保多数节点达成一致，避免 “少数派” 决策（如 Redis 哨兵判定主节点客观下线）。
2. **脑裂防护**：防止网络分区后，不同分区的节点各自独立决策（如集群分裂成两个小集群，只有拥有 quorum 节点的分区才能继续提供服务）。

### 二、典型应用场景

#### 1. Redis 哨兵（Sentinel）中的 Quorum

这是你之前问到的场景，Redis 哨兵的 quorum 用于判定主节点是否**客观下线**：

- 哨兵集群中，单个哨兵发现主节点无响应，会标记其为**主观下线（SDOWN）**。
- 该哨兵会向其他哨兵发起询问，**只有获得 ≥ quorum 数量的哨兵确认主节点下线**，才会将主节点标记为**客观下线（ODOWN）**，进而触发故障转移。

**配置示例**：

```conf
# 监控主节点 mymaster，quorum=2
sentinel monitor mymaster 127.0.0.1 6379 2
```

- 若哨兵集群有 3 个节点，quorum=2 表示至少 2 个哨兵确认，才能判定主节点客观下线。
- **quorum 的取值建议**：一般为 `哨兵节点数/2 + 1`（奇数集群），比如 3 个哨兵设 2，5 个哨兵设 3，避免平局。

#### 2. 分布式存储中的 Quorum（如 Cassandra、HBase）

在副本机制中，quorum 用于控制读写的一致性级别：

- **写 quorum**：写入操作需要至少 `W` 个副本确认成功，才算写入完成。

- **读 quorum**：读取操作需要至少 `R` 个副本返回数据，才能返回结果。

- 只要满足```R + W > N ```（```N```是副本总数），就能保证强一致性。例如 ```N=3, W=2, R=2```：写入时至少 2 个副本成功，读取时至少 2 个副本返回，必然能读到最新数据。

#### 3. Raft 共识算法中的 Quorum

Raft 算法选举 Leader 时，候选人必须获得**超过半数节点的投票**（即 `quorum = N/2 + 1`）才能当选 Leader。

- 比如 5 个节点的集群，quorum=3，候选人需要拿到 3 票才能成为 Leader。
- 这种机制保证了集群中最多只有一个 Leader，避免 “双主” 问题。

### 三、核心特点

1. **阈值特性**：quorum 是一个**最小数量阈值**，不是固定节点集合，只要满足数量即可。

2. 容错性：quorum 机制允许部分节点故障，只要存活节点数 ≥ quorum，系统就能正常决策。

   例如 3 个哨兵，quorum=2，即使 1 个哨兵故障，剩余 2 个仍能判定主节点状态。

3. **防脑裂**：网络分区时，只有包含 quorum 节点的分区能继续工作，另一个分区会被 “隔离”，避免数据冲突。

### 四、总结

quorum 的本质是 **“少数服从多数” 的分布式决策规则**，通过设定一个合理的票数阈值，在节点故障、网络分区的情况下，保证分布式系统的一致性和可用性。不同场景下 quorum 的取值和作用略有差异，但核心思想一致。


你说得对，Redis 哨兵确实依赖 Gossip 协议（流言协议）实现哨兵集群的**去中心化信息同步**，它和 Quorum、Raft 共同构成哨兵高可用的三大核心机制，以下是具体实现细节和作用边界。

------

### 一、哨兵中 Gossip 协议的核心定位

Gossip 在哨兵中的核心是**信息扩散与状态共享**，而非决策触发 —— 决策（客观下线、故障转移）由 Quorum 与 Raft 负责，两者分工明确：

| 机制       | 核心职责                     | 关键作用                       | 依赖协议 / 算法 |
| ---------- | ---------------------------- | ------------------------------ | --------------- |
| **Gossip** | 哨兵节点间状态同步、信息传播 | 扩散主观下线、同步节点列表     | 流言协议        |
| **Quorum** | 判定主节点客观下线           | 防脑裂，少数服从多数           | 法定票数阈值    |
| **Raft**   | 选举领头哨兵、执行故障转移   | 确保同一时刻仅一个领头执行转移 | 共识算法        |

------

### 二、Gossip 在哨兵中的具体实现

#### 1. 核心通信机制（3 个定时任务）

哨兵通过固定频率的消息交换，实现全网状态同步，无需中心协调：

1. **节点存活检测**：每 1 秒向所有已知的主、从节点及哨兵发送`PING`，检测节点存活，超时未收到`PONG`则标记为 SDOWN；
2. **主节点信息拉取**：每 10 秒向主节点发送`INFO`，获取从节点列表，动态更新拓扑；
3. **哨兵集群信息交换**：每 2 秒通过主节点的`__sentinel__:hello`频道，广播自身 IP、端口、状态及主节点状态，其他哨兵订阅该频道获取信息，完成状态同步。

#### 2. 核心消息类型

| 消息类型  | 作用                       | 发送时机                  |
| --------- | -------------------------- | ------------------------- |
| **PING**  | 检测节点存活               | 每 1 秒                   |
| **INFO**  | 获取主节点的从节点列表     | 每 10 秒（仅向主节点）    |
| **HELLO** | 广播哨兵自身状态与集群信息 | 每 2 秒（通过主节点频道） |
| **ASK**   | 询问主节点是否客观下线     | 哨兵发现 SDOWN 后         |

#### 3. 状态同步流程（以新哨兵加入为例）

1. 新哨兵启动，通过配置连接主节点；
2. 新哨兵向主节点发送`INFO`，获取从节点与现有哨兵列表；
3. 新哨兵通过`__sentinel__:hello`频道广播自身信息，现有哨兵接收后更新本地节点列表；
4. 现有哨兵向新哨兵同步主节点状态、SDOWN 标记等，新哨兵快速融入集群，无中心化协调开销。

------

### 三、Gossip 的核心特点与优缺点

#### 优点

- **去中心化**：无中心节点，任意哨兵故障不影响集群，容错性强；
- **动态扩展**：新哨兵加入无需修改现有配置，自动同步集群信息；
- **轻量高效**：通过固定频率广播，无需复杂协商，网络开销可控。

#### 缺点

- **最终一致性**：信息传播有延迟，极端情况下可能存在短时间状态不一致；
- **冗余通信**：消息会重复传播，集群规模过大时可能增加带宽开销（建议哨兵数≤5）。

------

### 四、与 Quorum、Raft 的协作关系

1. **Gossip + Quorum**：Gossip 扩散 SDOWN 状态，Quorum 判定 ODOWN—— 仅当超过 Quorum 数量的哨兵通过 Gossip 确认 SDOWN，才触发 ODOWN；
2. **Gossip + Raft**：Gossip 同步哨兵集群拓扑，确保 Raft 选举时所有哨兵都能参与投票，避免投票分裂。

------

### 五、关键配置与调优

| 配置项                    | 作用                     | 默认值  | 调优建议               |
| ------------------------- | ------------------------ | ------- | ---------------------- |
| `down-after-milliseconds` | SDOWN 超时阈值           | 30000ms | 网络不稳定时适当调大   |
| `sentinel monitor`        | 主节点监控与 Quorum 设置 | 无      | 3 节点哨兵设 Quorum=2  |
| `sentinel parallel-syncs` | 故障转移时从节点同步数   | 1       | 避免同步风暴，保持默认 |

------

### 总结

Gossip 协议是哨兵集群去中心化信息同步的基础，通过定时广播与订阅机制，实现哨兵间状态共享与拓扑更新，与 Quorum（判定下线）、Raft（选举与故障转移）协同，共同保障 Redis 主从集群的高可用。
