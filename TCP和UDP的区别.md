TCP（传输控制协议）和 UDP（用户数据报协议）是 TCP/IP 协议栈中**传输层**的核心协议，二者设计理念截然不同：TCP 追求**可靠、有序、面向连接**，UDP 追求**高效、无连接、轻量化**。以下从核心区别、底层实现细节、具体使用场景三方面展开，结合面试高频考点讲解：

## 一、核心区别（面试必背）

| 对比维度                | TCP（传输控制协议）                                          | UDP（用户数据报协议）                                        |
| ----------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **连接性**              | 面向连接（三次握手建立连接，四次挥手释放连接）               | 无连接（发送数据前无需建立连接，直接封装数据报发送）         |
| **可靠性**              | 可靠传输（通过序列号、确认应答、重传机制、流量控制、拥塞控制保证数据不丢失、不重复、有序） | 不可靠传输（无确认、无重传，数据可能丢失、重复、乱序，仅提供校验和验证数据完整性） |
| **有序性**              | 保证数据按发送顺序到达（通过序列号排序）                     | 不保证有序（数据报独立传输，可能乱序到达）                   |
| **数据边界**            | 面向字节流（无数据边界，接收方需自行处理数据拆分）           | 面向数据报（有明确数据边界，发送方发一次，接收方收一次，不合并、不拆分） |
| **拥塞控制 / 流量控制** | 支持（滑动窗口机制实现流量控制，慢启动、拥塞避免等算法实现拥塞控制） | 不支持（发送方无限制发送，可能导致网络拥塞）                 |
| **头部开销**            | 较大（固定头部 20 字节，可选头部最多 40 字节，包含序列号、确认号等控制字段） | 极小（固定头部 8 字节，仅包含源端口、目的端口、长度、校验和） |
| **传输效率**            | 较低（连接建立 / 释放、重传、拥塞控制等机制带来延迟）        | 极高（无额外控制开销，延迟低、实时性强）                     |
| **适用场景**            | 要求可靠传输的场景（文件传输、HTTP/HTTPS、数据库交互等）     | 要求实时性、可容忍少量丢包的场景（视频通话、游戏、广播等）   |

## 二、底层实现细节（面试加分点）

### 1. TCP：如何保证可靠传输？

TCP 的可靠性依赖以下核心机制，也是面试高频提问点：

- 三次握手：建立连接时，双方确认彼此的发送 / 接收能力，避免 “失效连接请求”（如网络延迟的旧连接请求被误处理）。

  - 客户端 → 服务端（SYN=1， seq=x）：请求建立连接；
  - 服务端 → 客户端（SYN=1， seq=y， ACK=x+1）：确认客户端请求，并发起自己的连接请求；
  - 客户端 → 服务端（ACK=y+1）：确认服务端请求，连接建立。

- 四次挥手：释放连接时，双方确认数据已传输完成，避免数据丢失。

  - 主动关闭方 → 被动关闭方（FIN=1）：请求关闭连接；
  - 被动关闭方 → 主动关闭方（ACK=FIN+1）：确认关闭请求（此时仍可发送剩余数据）；
  - 被动关闭方 → 主动关闭方（FIN=1）：告知主动关闭方 “我已无数据发送，可关闭”；
  - 主动关闭方 → 被动关闭方（ACK=FIN+1）：确认关闭，连接释放。

- 序列号与确认应答（ACK）：

  - 每个 TCP 段都有唯一序列号（seq），接收方收到后返回 “确认号 = seq+1”，表示 “已收到该段及之前的所有数据”；
  - 若发送方超时未收到 ACK，会重传该段数据（超时重传机制）。

- 滑动窗口：

  - 流量控制：接收方通过 “窗口大小” 告知发送方 “当前可接收的最大字节数”，避免发送方发送过快导致接收方缓冲区溢出；
  - 拥塞控制：发送方根据网络拥塞程度动态调整发送速率（慢启动→拥塞避免→快速重传→快速恢复），避免网络崩溃。

### 2. UDP：为何效率高？

UDP 的设计核心是 “极简”，去除所有非必要控制字段：

- 无连接：无需三次握手 / 四次挥手，减少连接开销；
- 无确认 / 重传：发送方发送数据后无需等待确认，直接继续发送；
- 无滑动窗口：无需维护窗口状态，头部仅 8 字节，封装和解封装速度极快；
- 校验和可选：UDP 的校验和仅用于验证数据完整性，若校验失败直接丢弃数据，不做任何补救（应用层可自行处理丢包）。

## 三、具体使用场景（结合实际应用）

### 1. TCP 的典型场景（要求可靠、不允许丢包）

- **文件传输**：FTP、SFTP、迅雷下载（核心需求是文件完整，可容忍延迟）；
- **HTTP/HTTPS**：浏览器与服务器的通信（网页内容、表单提交需可靠传输，否则会出现页面错乱、数据丢失）；
- **数据库交互**：MySQL、PostgreSQL 等数据库的 JDBC 连接（SQL 查询 / 更新需确保数据一致性，不能丢包或乱序）；
- **邮件传输**：SMTP（发送邮件）、POP3/IMAP（接收邮件）（邮件内容需完整送达）；
- **远程登录**：SSH、Telnet（远程操作命令需可靠传输，否则可能导致操作失误）。

### 2. UDP 的典型场景（要求实时性，可容忍少量丢包）

- **实时音视频通信**：Zoom、微信视频通话、直播（延迟敏感，少量丢包仅导致画面 / 声音短暂卡顿，不影响整体体验；若用 TCP，重传机制会导致延迟累积，出现 “音画不同步”）；
- **在线游戏**：王者荣耀、英雄联盟（游戏指令需低延迟传输，如移动、攻击指令；少量丢包可通过游戏逻辑补偿，如预测玩家位置，若用 TCP 会导致 “操作延迟”）；
- **广播 / 组播**：DNS 查询（UDP 查询速度快，若查询失败可重试；DNS 也支持 TCP，但仅用于大尺寸响应）、DHCP 分配 IP（局域网内广播，无需可靠传输）；
- **物联网（IoT）**：传感器数据上报（如温度、湿度传感器，数据量大、实时性要求高，少量丢包可接受）；
- **实时协作工具**：多人在线编辑（如腾讯文档）、实时弹幕（需低延迟同步，少量丢包不影响整体体验）。

### 3. 特殊场景：TCP 与 UDP 的结合使用

- **QUIC 协议**（HTTP/3 的底层协议）：基于 UDP 实现，融合了 TCP 的可靠性（序列号、确认应答、拥塞控制）和 UDP 的高效性（无连接、低延迟），解决了 TCP 的 “队头阻塞” 问题，广泛用于谷歌、抖音等平台；
- **流媒体传输**：HLS（HTTP Live Streaming）用 TCP 传输切片文件，而实时流用 UDP 传输（兼顾可靠性和实时性）。

## 四、面试高频追问与总结

### 追问 1：为何 DNS 用 UDP 而非 TCP？

- DNS 查询数据量小（通常小于 512 字节），UDP 头部开销小，查询速度快；
- 若查询结果超过 512 字节（如返回多个 IP 地址），DNS 会自动切换到 TCP 传输（UDP 最大载荷为 65507 字节，但实际受 MTU 限制，通常为 1500 字节，超过会分片，可靠性下降）；
- 少量查询失败可通过应用层重试弥补，无需 TCP 的复杂可靠机制。

### 追问 2：TCP 的 “队头阻塞” 是什么？如何解决？

- 队头阻塞：TCP 是面向字节流的，若前一个段丢失，后一个段即使到达也会被缓存，需等待丢失的段重传后才能交给应用层，导致后续数据延迟；
- 解决方案：HTTP/2 用 “多路复用”（一个 TCP 连接承载多个流）缓解，HTTP/3 基于 UDP 的 QUIC 协议彻底解决（每个流独立传输，互不影响）。

### 总结

- 选 TCP：当 “可靠性” 优先于 “实时性”，数据不能丢失、乱序时（如文件、数据库、HTTP）；
- 选 UDP：当 “实时性” 优先于 “可靠性”，可容忍少量丢包时（如音视频、游戏、广播）；
- 核心判断标准：**是否能接受 “数据丢失”** 和 **是否能容忍 “延迟”**。

记住一句话：**TCP 是 “可靠的慢车”，UDP 是 “高速的快车”**，根据业务需求选择合适的协议。
