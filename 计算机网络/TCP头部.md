### 一、TCP 头部格式与长度

TCP 头部用于携带控制信息，确保数据可靠传输，其格式和长度有明确规范。

#### 1. 头部长度

- **固定部分**：20 字节，包含源端口、目的端口、序列号、确认号等核心字段。
- **可选部分**：0-40 字节，用于选项字段（如 MSS、窗口扩大因子），因此 TCP 头部总长度范围为**20-60 字节**。
- 计算方式：头部长度字段占 4 位，单位为 “4 字节”，例如字段值为 5 时，头部长度 = 5×4=20 字节。

#### 2. 核心头部字段（固定部分）

| 字段              | 长度（位） | 核心作用                                                 |
| ----------------- | ---------- | -------------------------------------------------------- |
| 源端口 / 目的端口 | 16/16      | 标识发送端和接收端的应用程序                             |
| 序列号            | 32         | 标记当前发送数据的字节位置，用于排序和去重               |
| 确认号            | 32         | 确认已收到的对方数据，值 = 期望接收的下一字节序列号      |
| 头部长度          | 4          | 指示 TCP 头部总长度（单位：4 字节）                      |
| 控制位            | 6          | 包含 SYN（连接建立）、ACK（确认）、FIN（连接关闭）等标志 |
| 窗口大小          | 16         | 告知对方自己当前可接收的最大数据量（字节）               |
| 校验和            | 16         | 校验头部和数据，检测传输差错                             |
| 紧急指针          | 16         | 指向紧急数据的位置（仅 URG 位为 1 时有效）               |

------

### 二、TCP 默认窗口大小

TCP 窗口大小决定了接收端一次能接收的最大数据量，是流量控制的核心。

1. **基础默认值**：TCP 头部的窗口大小字段为 16 位，因此理论默认最大值为**65535 字节**（2^16 - 1）。
2. **现代优化**：实际应用中，通过 “窗口扩大选项”（TCP 选项字段的一种）可将窗口大小扩展到 32 位，支持最大**4GB**的窗口，以适应高速网络（如千兆 / 万兆网）的大流量传输需求。
3. **动态调整**：窗口大小并非固定，接收端会根据自身缓存空间、CPU 负载动态调整，通过 ACK 报文告知发送端，避免接收端过载。

------

### 三、数据太大的解决办法：TCP 分段

当 TCP 报文（头部 + 数据）超过底层 IP 协议的 MTU（最大传输单元，默认 1500 字节）时，会触发**TCP 分段**。

1. **分段依据**：TCP 会根据 IP 层的 MTU 计算 “最大分段大小（MSS）”，公式为：MSS = MTU - IP 头部长度（默认 20 字节） - TCP 头部长度（默认 20 字节），即默认 MSS 为 1460 字节。
2. **分段过程**：发送端将大数据拆分为多个符合 MSS 的 “TCP 分段”，每个分段携带独立的序列号（基于原数据的字节位置），再由 IP 层封装为 IP 数据包发送。
3. **接收端处理**：接收端根据分段的序列号重组数据，恢复为完整的原始数据后，再交给应用层。

------

### 四、分片后是否会乱序？

**会出现乱序**，但 TCP 会通过机制解决。

1. **乱序原因**：IP 层转发数据包时，可能因路由不同、链路拥堵程度差异，导致不同 TCP 分段的传输延迟不同，出现 “后发送的分段先到达” 的情况。
2. **解决机制**：接收端通过 TCP 分段的 “序列号” 判断顺序，将乱序的分段暂存于 “接收缓存”，待所有前序分段到达后，按序列号从小到大重组数据，再交付应用层。

------

### 五、出现差错的解决办法：TCP 差错控制

TCP 通过 “校验和、确认重传、超时重传” 三大机制处理传输差错（如数据丢失、损坏、重复）。

1. **差错检测**：通过 TCP 头部的 “校验和” 字段，接收端对头部和数据进行校验，若校验失败，直接丢弃该分段。

2. 确认重传（ACK 机制） ：

    - 接收端成功收到分段后，会发送 ACK 报文，告知发送端 “已收到 XX 序列号之前的所有数据”。
    - 若发送端未收到某个分段的 ACK（可能分段丢失），会触发重传；若收到 “重复 ACK”（连续 3 次收到相同 ACK），会判断对应分段丢失，立即重传（快速重传）。

3. **超时重传**：发送端为每个分段设置 “超时计时器”，若计时器到期仍未收到 ACK，会重传该分段，且超时时间会根据网络延迟动态调整（避免频繁无效重传）。
